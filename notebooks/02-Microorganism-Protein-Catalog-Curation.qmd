---
title: "Protein Catalog Curation"
editor: visual
author: "Joe Boktor"
date: '2023-01-24'
eval: false
format: 
  html:
    font-family: helvetica neueu
    page-layout: full
    toc: true
    toc-location: left
    toc-depth: 3
    self-contained: true
    code-fold: true
    code-tools: true
    fig-align: center
bibliography: references.bib
---

## Data sources

#### **Unified Human Gastrointestinal Genome (UHGG/UHGP)**

Global genome compendium curated from human stool samples and strain isolates from 31 countries across six continents. This catalog includes 289,232 prokaryotic genomes clustered into 4,744 species representatives. These genomes encode \>170 million protein sequences, collated in the Unified Human Gastrointestinal Protein (UHGP) catalog. The UHGP more than doubles the number of gut proteins in comparison to those present in the Integrated Gene Catalog. More than 70% of the UHGG species lack cultured representatives, and 40% of the UHGP lack functional annotations [@almeida2021].

#### **Human Reference Gut Microbiome - Korean, India, Japanese data-sets (HRGM-KIJ)**

An addition of under-represented Asian countries to the UHGG v1 , with 90, 110, and 645 human microbiome samples collected from Korea, India, and Japan, respectively. Genome assembly produced 29,082 prokaryotic genomes from 845 fecal metagenomes [@merrill].

#### **Early-Life Gut Genomes (ELGG)**

ELGG contains 32,277 genomes representing 2,172 species from 6,122 fecal metagenomes collected from children under 3 years old spanning delivery mode, gestational age, feeding pattern, and geography. The ELGG substantially expanded the phylogenetic diversity by 38% over the isolate microbial genomes, and the genomic landscape of the early-life microbiome by increasing recruitment of metagenomic reads to 82.8%. More than 60% of the ELGG species lack an isolate representative. The conspecific genomes of the most abundant species from children differed in gene diversity and functions compared to adults. The ELGG genomes encode over 80 million protein sequences, forming the Early-Life Gut Proteins (ELGP) catalog with over four million protein clusters, 29.5% of which lacked functional annotations [@zeng2022].

#### **Hadza**

Ultra-deep metagenomic sequencing and strain cultivation on 351 fecal samples from the Hadza, hunter-gatherers in Tanzania, and comparative populations in Nepal and California. This data set contains 94,971 genomes of bacteria, archaea, bacteriophages, and eukaryotes, 43% of which are absent from existing unified datasets [@merrill].

#### **RUMMETA**

A ruminant gastrointestinal microbial reference catalog with 154,335,274 non-redundant genes and 8,745 uncultured species from over 10,373 metagenome-assembled genomes (MAGs). This genome compendium was built from 370 gastrointestinal (GIT) content samples, spanning 10 different GIT regions sampled from seven ruminant species (dairy cattle, *Bos taurus*; water buffalo, *Bubalus bubalis*; yak, *Bos grunniens*; goat, *Capra aegagrus*; sheep, *Ovis aries*; roe deer, *Capreolus pygargus*; water deer, *Hydropotes inermis*) [@xie2021].

#### **Rumen-Uncultured Genomes (RUGs)**

5,588 rumen MAGs collected from 283 ruminant beef cattle and 24 rumen fluid samples from six Boran (*Bos indicus*), indigenous Zebu cattle from sub-Saharan Africa [@wilkinson2020; @stewart2019].

#### **EuPathDB**

EuPathDB includes 11 databases (AmoebaDB, CryptoDB, FungiDB, GiardiaDB, HostDB, MicrosporidiaDB, OrthoMCLDB, PiroplasmaDB, PlasmoDB, ToxoDB, TrichDB, TriTrypDB, and VectorBase) which together represent 689 eukaryotic microorganisms. This data includes both known pathogens and other closely related non-infectious eukaryotic species[@aurrecoechea2013].

#### **Metagenomic Gut Virus catalog (MGV)**

189,680 viral genomes from 11,810 publicly available human stool metagenomes with 11,837,198 non-redundant proteins identified. Over 75% of genomes represent double-stranded DNA phages that infect members of the Bacteroidia and Clostridia classes. Sequence clustering reveals 54,118 candidate viral species, 92% of which were not found in existing databases. The Metagenomic Gut Virus catalog improves detection of viruses in stool metagenomes and accounts for nearly 40% of CRISPR spacers found in human gut Bacteria and Archaea [@nayfach2021].

#### **WormBase ParaSite (WBPS17)**

Databases consisting of 210 genomes, representing 169 distinct species from the Nemotoda (Roundworm) and Plathelminthes (Flatworm) phyla [@harris2020].

## Data sources summary

+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| Catalog                                                            | Release | Domain(s) | Samples                            | Genomes | Proteins (95%) | DOI                                                                                            | catalog                                                                                                                           |
+====================================================================+=========+===========+====================================+=========+================+================================================================================================+===================================================================================================================================+
| **UHGG/UHGP**                                                      | 2022    | Bacteria  | 25,088 + cultured genome resources | 289,232 | 18,482,368     | [link](https://www.nature.com/articles/s41587-020-0603-3)                                      | [link](http://ftp.ebi.ac.uk/pub/databases/metagenomics/mgnify_genomes/human-gut/v2.0.1/)                                          |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| Mgnify Unified Human Gastrointestinal Genomes/Proteins v2.0.1      |         | Archaea   |                                    |         |                | [link](https://www.nature.com/articles/s41591-019-0559-3)                                      |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **HRGM-KIJ**                                                       | 2021    | Bacteria  | 845                                | 29,082  | 6,312,390      | [link](https://genomemedicine.biomedcentral.com/articles/10.1186/s13073-021-00950-7)           | [link](https://www.mbiomenet.org/HRGM/listdir.php?directory=data/protein_catalog)                                                 |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| Human Reference Gut Microbiome (Korea, India, Japan)               |         | Archaea   |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **ELGG/ELGP**                                                      | 2022    | Bacteria  | 32,277                             | 6,122   | 3,879,904      | [link](https://www.nature.com/articles/s41467-022-32805-z)                                     | [link](https://zenodo.org/record/6969520/files/ELGP_95.faa.gz)                                                                    |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| Early-Life Gut Genomes/Proteins                                    |         | Archaea   |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **Hadza**                                                          | 2022    | Bacteria  | 388                                | 94,971  | 32,431,351     | [link](https://www.biorxiv.org/content/10.1101/2022.03.30.486478v2.full)                       | [link](https://www.ebi.ac.uk/ebisearch/search/cross-references?db=project&id=PRJEB49206&ref=genomes&requestFrom=relatedData-xref) |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| African Hadza tribe and comparative Nepali, and California samples |         | Archaea   |                                    |         |                |                                                                                                |                                                                                                                                   |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
|                                                                    |         | Virus     |                                    |         |                |                                                                                                |                                                                                                                                   |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
|                                                                    |         | Eukaryote |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **RUMMETA**                                                        | 2021    | Bacteria  | 370                                | 10,373  | 109,586,913    | [link](https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-021-01078-x#MOESM5) | [link](http://rummeta.njau.edu.cn/rumment/download/downloadFile?file=RGMGC.geneSet.faa.gz)                                        |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| 10 GIT regions of seven ruminant species                           |         | Archaeal  |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **RUGs**                                                           | 2019    | Bacteria  | 207                                | 5,588   | 5,502,611      | [link](https://www.nature.com/articles/s41587-019-0202-3)                                      | [link](http://ftp.ebi.ac.uk/pub/databases/metagenomics/mgnify_genomes/cow-rumen/v1.0/protein_catalogue/)                          |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| MGnify Cow Rumen v1.0                                              |         | Archaeal  |                                    |         |                | [link](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-020-02144-7)            |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **MGV**                                                            | 2021    | Virus     | \_                                 | 189,680 | 1,725,656      | [link](https://www.nature.com/articles/s41564-021-00928-6)                                     | [link](https://portal.nersc.gov/MGV/MGV_v1.0_2021_07_08/)                                                                         |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| Metagenomic Gut Virus Catalog                                      |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **WormBase ParaSite** (WBPS17)                                     | 2019    | Eukaryote | \_                                 | 210     | 10,328,252     | [link](https://academic.oup.com/nar/article/48/D1/D762/5603222)                                | [link](https://parasite.wormbase.org/ftp.html)                                                                                    |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| **EuPathDB**                                                       | 2022    | Eukaryote | \_                                 | 689     | 3,456,934      | [link](https://academic.oup.com/nar/article/41/D1/D684/1059841)                                | [link](https://veupathdb.org/veupathdb/app/downloads/Current_Release/)                                                            |
|                                                                    |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
| eukaryotic pathogen database (Release 61)                          |         |           |                                    |         |                |                                                                                                |                                                                                                                                   |
+--------------------------------------------------------------------+---------+-----------+------------------------------------+---------+----------------+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+

## Downloading and Formatting Sequence Data

Analysis Setup

```{r}
library(tidyverse)
library(reticulate)
library(magrittr)
library(glue)
library(seqinr)
library(future)
library(future.batchtools)
library(fs)
library(tictoc)
library(listenv)
library(progress)

tmpdir <- "/central/scratch/jbok/tmp"
homedir <- "/central/groups/MazmanianLab/joeB"
wkdir <- glue(
  "{homedir}/",
  "Microbiota-Immunomodulation/Microbiota-Immunomodulation"
)
src_dir <- glue("{wkdir}/notebooks")
source(glue("{src_dir}/R-scripts/helpers_general.R"))
source(glue("{src_dir}/R-scripts/helpers_sequence-screens.R"))
protein_catalogs <- glue("{homedir}/", "Downloads/protein_catalogs")
```

#### UHGP v 2.0

```{r, eval = FALSE}
uhgp_ftp_links <- 
  paste0(
    "http://ftp.ebi.ac.uk/pub/databases/metagenomics/mgnify_genomes/",
    "human-gut/v2.0.1/protein_catalogue/uhgp-", 
    c(100, 95, 90, 50), ".tar.gz"
  )

for (f in uhgp_ftp_links) {
  jname <- fs::path_ext_remove(basename(f))
  wget_download_slurm(
    jobname = jname,
    slurm_out = "/central/scratch/jbok/slurmdump/",
    download_link = f,
    output_dir = protein_catalogs
  )
}

```

```{r, eval=FALSE}
# Unzip uhgp-100.tar.gz
slurm_shell_do(
  cmd = glue("tar -xvzf {protein_catalogs}/UHGP_v2.0.1/uhgp-95.tar.gz",
    " -C {protein_catalogs}/UHGP_v2.0.1/"),
  memory = "200G",
  walltime = 144000
)

```

#### ELGG

```{r, eval = FALSE}
# Download 95% ELGG protein faa via https://zenodo.org/record/6969520/files/ELGP_95.faa.gz?download=1
# wget https://zenodo.org/record/6969520/files/ELGP_95.faa.gz 
wget_download_slurm(
  jobname = "ELGG",
  download_link = "https://zenodo.org/record/6969520/files/ELGP_95.faa.gz",
  slurm_out = "/central/scratch/jbok/slurmdump/",
  output_dir = protein_catalogs
  )
  
```

```{r, eval=FALSE}
# Unzip ELGP_95.faa.gz
slurm_shell_do(
  cmd = glue("gunzip {protein_catalogs}/ELGP_95.faa.gz"),
  memory = "50G",
  walltime = 36000
)
# shell_do("gunzip /central/groups/MazmanianLab/joeB/Downloads/protein_catalogs/ELGP_95.faa.gz")

```

#### KIJ

```{r, eval = FALSE}
# HRGM (KIJ 100 only) using 110 India, 645 Japan, and 90 Korean fecal samples
# https://www.mbiomenet.org/HRGM/data/protein_catalog/2.KIJ_CD-HIT-100_Proteins/KIJ_CD-HIT-100_Proteins.faa.gz
wget_download_slurm(
  jobname = "HRGM_KIJ100",
  download_link = "https://www.mbiomenet.org/HRGM/data/protein_catalog/2.KIJ_CD-HIT-100_Proteins/KIJ_CD-HIT-100_Proteins.faa.gz",
  slurm_out = "/central/scratch/jbok/slurmdump/",
  output_dir = protein_catalogs
)

```

```{r, eval=FALSE}
# Unzip
slurm_shell_do(
  cmd = glue("gunzip {protein_catalogs}/KIJ_CD-HIT-100_Proteins.faa.gz"),
  memory = "50G",
  walltime = 36000
)
# shell_do("gunzip /central/groups/MazmanianLab/joeB/Downloads/protein_catalogs/KIJ_CD-HIT-100_Proteins.faa.gz")

```

#### Hadza/Nepali Hunter-Gatherers

```{r, eval = FALSE}
# Downloading Hadza Mag metadata
shell_do(glue(
  "mkdir -p {wkdir}/data/input/protein_catalog_metadata"
))
shell_do(glue(
  "wget -P {wkdir}/data/input/protein_catalog_metadata/",
  " https://www.biorxiv.org/content/biorxiv/early/2022/10/07/2022.03.30.486478/DC2/embed/media-2.xlsx",
))
shell_do(glue(
  "mv {wkdir}/data/input/protein_catalog_metadata/media-2.xlsx",
  " {wkdir}/data/input/protein_catalog_metadata/Hadza-MAG-metadata.xlsx"
))

```

```{r, eval = FALSE}
hadza_meta_PRJEB49206 <-
  read.delim(
    glue(
      "{wkdir}/data/input/protein_catalog_metadata/",
      "filereport_analysis_PRJEB49206_tsv.txt"
    ),
    stringsAsFactors = FALSE, header = TRUE
  )

# get list of files that don't currently exist
hadza_files_unprocessed_lgr <-
  hadza_meta_PRJEB49206$submitted_ftp %>%
  purrr::map(~ !(
    file.exists(glue("{hadza_metagenomes_dir}/{basename(.)}")) |
      file.exists(glue(
        "{hadza_metagenomes_dir}/",
        "{fs::path_ext_remove(basename(.))}"
      ))
  ))

hadza_files_unprocessed <- 
  hadza_meta_PRJEB49206$submitted_ftp %>%
  keep(unlist(hadza_files_unprocessed_lgr))

# Initiate future.batchtools backend for parallel processing
future::plan(
  future.batchtools::batchtools_slurm,
  template = glue("{wkdir}/batchtools_templates/batchtools.slurm.tmpl"),
  resources = list(
    name = "hadza_agg-download",
    memory = "1G",
    ncpus = 2,
    walltime = 360000
  )
)

# Chunk files (100 per job) and download
tic()
n_jobs <- ceiling(length(hadza_files_unprocessed) / 100)
download_runs <- listenv()

for (job in 1:n_jobs) {
  input_chunk <- chunk_func(hadza_files_unprocessed, n_jobs)[[job]]
  download_runs[[job]] %<-% wget_path_list(
    download_list = input_chunk,
    download_dir = "/central/scratch/jbok/PRJEB49206_HADZA"
  )
}
toc()
# list.files("/central/scratch/jbok/PRJEB49206_HADZA") %>% length

```

```{r, eval = FALSE}
#______________________________________________________________________
# Prodigal on Hadza MAGs ----
# Initiate future.batchtools backend for parallel processing
future::plan(
  future.batchtools::batchtools_slurm,
  template = glue("{wkdir}/batchtools_templates/batchtools.slurm.tmpl"),
  resources = list(
    name = "prodigal-Hadza-MAGs",
    memory = "5G",
    ncpus = 1,
    walltime = 360000
  )
)

# select input genome fasta files paths for prodigal
hadza_proteins_dir <- glue(
  "{homedir}/Downloads/",
  "protein_catalogs/hadza_proteins"
)
hadza_mag_paths <-
  list.files(
    path = "/central/scratch/jbok/PRJEB49206_HADZA",
    full.names = TRUE
  )
hadza_mag_unprocessed_lgr <-
  hadza_mag_paths %>%
  purrr::map( ~ !file.exists(glue("{hadza_proteins_dir}/{basename(.)}")))

hadza_mag_paths_to_process <-
  hadza_mag_paths %>%
  keep(unlist(hadza_mag_unprocessed_lgr))

# generate list of desired fasta outputs
hadza_proteins_paths <-
  purrr::map(
    hadza_mag_paths_to_process,
    ~ glue("{hadza_proteins_dir}/{fs::path_ext_remove(basename(.))}")
  )

# Chunk files (500 per job) and download
tic()
n_jobs <- ceiling(length(hadza_mag_paths_to_process) / 25)
prodigal_runs <- listenv()

for (job in 1:n_jobs) {
  input_list <- chunk_func(hadza_mag_paths_to_process, n_jobs)[[job]]
  output_list <- chunk_func(hadza_proteins_paths, n_jobs)[[job]]
  prodigal_runs[[job]]  %<-% shell_do_prodigal_list(
    input_genome_list = input_list,
    output_fasta_list = output_list
  )
}
toc()

hadza_files <- list.files(
  glue("{protein_catalogs}/hadza_proteins"),
  full.names = TRUE
  )

hadza_files %>% length
```

```{r, eval=FALSE}
pb <- progress_bar$new(total = length(hadza_files),
  format = "[:bar] :current/:total (:percent)"
  )

for (f in hadza_files){
  pb$tick()
  shell_do(glue(
    "cat {f} >> {protein_catalogs}/hadza.fasta"
    ))
}

```

#### Ruminants - RUMMETA

```{r, eval = FALSE}
#' https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-021-01078-x 
#' An integrated gene catalog and over 10,000 metagenome-assembled genomes 
#' from the gastrointestinal microbiome of ruminants
# http://rummeta.njau.edu.cn/rumment/download/downloadFile?file=RGMGC.geneSet.faa.gz

wget_download_slurm(
  jobname = "RUMMETA",
  download_link = "http://rummeta.njau.edu.cn/rumment/download/RGMGC.geneSet.faa.gz", 
  slurm_out = "/central/scratch/jbok/slurmdump/",
  output_dir = protein_catalogs
  )

```

```{r, eval=FALSE}
slurm_shell_do(
  cmd = glue("gunzip {protein_catalogs}/RGMGC.geneSet.faa.gz"),
  memory = "50G",
  walltime = 36000
)
```

#### Ruminants - RUGs

```{r, eval = FALSE}
rug_ftp_links <- 
  paste0(
    "http://ftp.ebi.ac.uk/pub/databases/metagenomics/mgnify_genomes/",
    "cow-rumen/v1.0/protein_catalogue/protein_catalogue-", 
    c(100, 95, 90, 50), ".tar.gz")

for (f in rug_ftp_links) {
  jname <- fs::path_ext_remove(basename(f))
  wget_download_slurm(
    jobname = jname,
    slurm_out = "/central/scratch/jbok/slurmdump/",
    download_link = f,
    output_dir = glue("{protein_catalogs}/cow-rumen-v1.0")
  )
}

```

```{r, eval=FALSE}
slurm_shell_do(
  cmd = glue("tar -xvzf {protein_catalogs}/cow-rumen-v1.0/protein_catalogue-95.tar.gz",
  " -C {protein_catalogs}/cow-rumen-v1.0/"),
  memory = "50G",
  walltime = 36000
)

```

#### MGV

```{r, eval = FALSE}
wget_download_slurm(
  jobname = "MGV_proteins",
  download_link = "https://portal.nersc.gov/MGV/MGV_v1.0_2021_07_08/mgv_proteins.faa", 
  slurm_out = "/central/scratch/jbok/slurmdump/",
  output_dir = protein_catalogs
  )

```

#### VEuPathDB

```{r, eval = FALSE}
protein_catalogs <- glue("{homedir}/", "Downloads/protein_catalogs/")
VEuPathDB_meta <-
  read.delim(glue("{wkdir}/data/input/protein_catalog_metadata/VEuPathDB_release-61_2022-12-15.txt"),
    stringsAsFactors = FALSE, header = TRUE
  )

# checking length of data
VEuPathDB_links <- VEuPathDB_meta$protein_fasta_link %>% unique()
VEuPathDB_links %>% length()

for (f in VEuPathDB_links) {
  if (!file.exists(glue("{protein_catalogs}/VEuPathDB_v61/{basename(f)}"))){
    jname <- fs::path_ext_remove(basename(f))
    wget_download_slurm(
      jobname = jname,
      slurm_out = "/central/scratch/jbok/slurmdump/",
      download_link = f,
      output_dir = glue("{protein_catalogs}/VEuPathDB_v61")
    )
  Sys.sleep(5)
  }
}

```

```{r, eval = FALSE}
# Some runs failed, collect and examine filepaths
download_failed <- list()
for (f in VEuPathDB_links) {
  if (!file.exists(glue("{protein_catalogs}/VEuPathDB_v61/{basename(f)}"))){
    jname <- fs::path_ext_remove(basename(f))
    download_failed[[jname]] <- f
  }
}

# rerun download failures, downloading genomes (nt) instead of proteins (aa)
download_failed %<>% purrr::map(
  ~ gsub("AnnotatedProteins", "Genome", .)
)
for (f in download_failed) {
  if (!file.exists(glue("{protein_catalogs}/VEuPathDB_v61/{basename(f)}"))){
    jname <- fs::path_ext_remove(basename(f))
    wget_download_slurm(
      jobname = jname,
      slurm_out = "/central/scratch/jbok/slurmdump/",
      download_link = f,
      output_dir = glue("{protein_catalogs}/VEuPathDB_v61/Genomes/")
    )
  Sys.sleep(1)
  }
}

# Initiate future.batchtools backend for parallel processing
future::plan(
  future.batchtools::batchtools_slurm,
  template = glue("{wkdir}/batchtools_templates/batchtools.slurm.tmpl"),
  resources = list(
    name = "prodigal-VEuPathDB-Genomes",
    memory = "5G",
    ncpus = 1,
    walltime = 36000
  )
)

VEuPathDB_genome_paths <-
  list.files(
    glue("{homedir}/Downloads/protein_catalogs/VEuPathDB_v61/Genomes"),
    full.names = TRUE
  )

for (genome_path in VEuPathDB_genome_paths) {
  output_file_name <- gsub(
    "Genome", "AnnotatedProteins", basename(genome_path)
  )
  output_file <-
    glue("{homedir}/Downloads/protein_catalogs/VEuPathDB_v61/{output_file_name}")
  fout %<-% {
    shell_do_prodigal(
      input_genome = genome_path,
      output_fasta = output_file
    )
  }
}
```

```{r, eval=FALSE}
# concatenate individual fasta files
slurm_shell_do(
  cmd = glue(
    "cat {protein_catalogs}/VEuPathDB_v61/*.f* >",
    " {protein_catalogs}/VEuPathDB_v61.fasta"
  ),
  memory = "10G"
)

```

#### WormBase

```{r, eval = FALSE}
wormbase_meta <-
  read.delim(
    glue(
      "{wkdir}/data/input/protein_catalog_metadata/",
      "2023-02-09_WormBase-genomes.txt"
    ),
    stringsAsFactors = FALSE, header = TRUE
  )

for (f in wormbase_meta$Proteins) {
  jname <- fs::path_ext_remove(basename(f))
  if (!file.exists(glue("{protein_catalogs}/wormbase-v17.0/{basename(f)}"))){
    wget_download_slurm(
      jobname = jname,
      slurm_out = "/central/scratch/jbok/slurmdump/",
      download_link = f,
      output_dir =  glue("{protein_catalogs}/wormbase-v17.0")
    )
    Sys.sleep(0.5)
  }
}
```

```{r, eval=FALSE}
slurm_shell_do(
  cmd = glue("gunzip {protein_catalogs}/wormbase-v17.0/*.gz"),
  memory = "5G",
  walltime = 360000
)

```

```{r, eval=FALSE}
# concatenate individual fasta files
slurm_shell_do(
  cmd = glue(
    "cat {protein_catalogs}/wormbase-v17.0/* >",
    " {protein_catalogs}/wormbase-v17.0.fasta"
  ),
  memory = "10G"
)

```

## Catalog Assembly

MMSeq2 95% similarity clustering of each catalog independently to remove redundant sequences

```{r}
# Utility function for running MMSeq2 clustering on the HPC
slurm_shell_do_mmseq2_clust <- function(input_fasta,
                                        output,
                                        jobname = glue("MMSeq2-{rand_string()}"),
                                        memory = "120G", # per cpu
                                        ncpus = 12,
                                        walltime = 36000,
                                        tmpdir = "/central/scratch/jbok/tmp",
                                        working_dir = wkdir) {
  source(glue("{working_dir}/notebooks/R-scripts/helpers_general.R"))
  mmseq_cmd <- glue(
    "mmseqs easy-linclust --cov-mode 1 -c 0.8",
    " --kmer-per-seq 200",
    " --min-seq-id 0.95",
    " --threads {ncpus}",
    " {input_fasta}",
    " {output}",
    " {tmpdir}"
  )
  slurm_shell_do(
    cmd = mmseq_cmd,
    jobname = jobname,
    memory = memory,
    ncpus = ncpus,
    walltime = walltime,
    working_dir = working_dir
  )
}
```

```{r}
catalog_paths <- list(
  "UHGP" = glue("{protein_catalogs}/UHGP_v2.0.1/uhgp-95/uhgp-95.faa"),
  "ELGG" = glue("{protein_catalogs}/ELGP_95.faa"),
  "KIJ" = glue("{protein_catalogs}/KIJ_CD-HIT-100_Proteins.faa"),
  "Hadza" = glue("{protein_catalogs}/hadza.fasta"),
  "RUMMETA" = glue("{protein_catalogs}/RGMGC.geneSet.faa"),
  "RUGS" = glue("{protein_catalogs}/cow-rumen-v1.0/protein_catalogue-95/protein_catalogue-95.faa"),
  "MGV" = glue("{protein_catalogs}/mgv_proteins.faa"),
  "VEuPathDB" = glue("{protein_catalogs}/VEuPathDB_v61.fasta"),
  "Wormbase" = glue("{protein_catalogs}/wormbase-v17.0.fasta")
)
```

```{r, eval=FALSE}
for (catalog in names(catalog_paths)) {
  print(catalog)
  output_dir <- glue("{protein_catalogs}/clustered_catalogs/{catalog}")
  shell_do(glue("mkdir -p {output_dir}"))
  if (file.exists(
    glue("{output_dir}/{catalog}-MMSeq2-95_rep_seq.fasta")
  )) {
    message(catalog, " file already exists ...")
    next
  }
  slurm_shell_do_mmseq2_clust(
    input_fasta = catalog_paths[[catalog]],
    output = glue("{output_dir}/{catalog}-MMSeq2-95")
  )
}

```

Adding a unique catalog ID to the headers of all FASTAs

```{r, eval=FALSE}
clustered_rep_paths <-
  names(catalog_paths) %>%
  purrr::set_names() %>%
  purrr::map(
    ~ glue(
      "{protein_catalogs}/clustered_catalogs/{.}/",
      "{.}-MMSeq2-95_rep_seq.fasta"
    ))

# check that files exist
if (!all(purrr::map(clustered_rep_paths, ~ file.exists(.)) %>% unlist )) stop()

clustered_named_rep_paths <- list()
for (catalog in names(clustered_rep_paths)) {
  clustered_named_rep_paths[[catalog]] <- glue(
      "{protein_catalogs}/clustered_catalogs/{catalog}/",
      "{catalog}-MMSeq2-95_rep_seq_renamed.fasta"
    )
  if (file.exists(clustered_named_rep_paths[[catalog]])) {
    message(catalog, " file already exists ...")
    next
  }
  message("Annotating: ", catalog)
  slurm_shell_do(
    glue(
      "/home/jboktor/bbmap/bbrename.sh",
      " in={clustered_rep_paths[[catalog]]}",
      " out={clustered_named_rep_paths[[catalog]]}",
      " prefix=CATID_{catalog}",
      " addprefix=t",
      " fixjunk=t",
      " -Xmx100g"
    ),
    memory = "100G", 
    walltime = 36000
  )
  Sys.sleep(2)
}

```

Collecting summary metrics for each clustered catalog

```{r, eval=FALSE}
clust_catalog_protein_n <- list()
for (catalog in names(clustered_rep_paths)) {
  message("Counting proteins in: ", catalog)
  clust_catalog_protein_n[[catalog]] <- 
    shell_do(
        glue("grep -c '^>' {clustered_rep_paths[[catalog]]}"),
        stdout_path = TRUE
    )  %>% 
    as.numeric
}
```

Concatenating clustered FASTAs

```{r, eval=FALSE}
shell_do(glue("mkdir -p {protein_catalogs}/clustered_catalogs/merged"))

# check that files exist
if (!all(purrr::map(
  clustered_named_rep_paths, ~ file.exists(.)
  ) %>% unlist )) stop()

for (catalog_path in clustered_named_rep_paths) {
  message("Merging", catalog_path)
  # pause execution until previous job is complete
  check_slurm_overload(njobs = 1, interval = 5)
  slurm_shell_do(glue(
    "cat {catalog_path} >> ",
    "{protein_catalogs}/clustered_catalogs/merged/",
    "2023-02-13_concatenated-catalog.fasta"
  ), memory = "50G")
}
```

MMSeq2 95% similarity clustering of concatenated catalogs

```{r, eval=FALSE}
slurm_shell_do_mmseq2_clust(
  input_fasta = glue(
    "{protein_catalogs}/clustered_catalogs/",
    "merged/2023-02-13_concatenated-catalog.fasta"
  ),
  output = glue(
    "{protein_catalogs}/clustered_catalogs/",
    "merged/2023-02-13_catalog_MMSeq2-95"
  ),
  memory = "128G",
  ncpus = 8
)

```

Chunking protein catalog into 50 bins

```{r}

#' function to divide original fasta into N smaller fasta files, roughly even in size
#' using bash awk
get_awk_chunk_cmd <- function(fasta_path, nbins, output_dir){
  filename <- fs::path_ext_remove(basename(fasta_path))
  protein_n <- shell_do(glue("grep -c '^>' {fasta_path}"), 
    stdout_path = TRUE
    ) %>% 
    as.numeric()
  proteins_per_file <- ceiling(protein_n/nbins)
  chunk_cmd <- glue(
    "awk 'BEGIN {n=0;} /^>/ ",
    "{if(n%{{proteins_per_file}==0)",
    "{file=sprintf(\"{{output_dir}/{{filename}_chunk_%d.fasta\",n);} ",
    "print >> file; n++; next;} { print >> file; }' ",
    "< {{fasta_path}", 
     .open = "{{")
  return(chunk_cmd)
}

```

```{r}
slurm_shell_do(
  cmd = get_awk_chunk_cmd(
    fasta_path = 
      glue("{protein_catalogs}/clustered_catalogs/merged/",
        "2023-02-13_catalog_MMSeq2-95_rep_seq.fasta"),
    output_dir = 
      glue("{protein_catalogs}/clustered_catalogs/merged/chunked_fasta"),
    nbins = 50
    ),
    jobname = glue("chunk-catalog-{rand_string()}"), working_dir = wkdir, 
    memory = "100G", 
    ncpus = 1, 
    walltime = 360000
)

```

## Results

At 95% similarity, our catalog contains 164,949,326 unique protein sequences. This compendium represents the global human and ruminant gut microbiome genomic repertoire, in addition to common eukaryotic pathogens.
